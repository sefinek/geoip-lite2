const e=require('fs'),t=require('net'),r=require('path'),n=require('async'),i=require('./utils.js'),a=require('./fsWatcher.js'),{version:o}=require('../package.json');e.existsSync=e.existsSync||r.existsSync;const c='dataWatcher',s=r.resolve(__dirname,global.geoDataDir||process.env.geoDataDIR||'../data/'),f={city:r.join(s,'geoip-city.dat'),city6:r.join(s,'geoip-city6.dat'),cityNames:r.join(s,'geoip-city-names.dat'),country:r.join(s,'geoip-country.dat'),country6:r.join(s,'geoip-country6.dat')},l=[[i.aton4('10.0.0.0'),i.aton4('10.255.255.255')],[i.aton4('172.16.0.0'),i.aton4('172.31.255.255')],[i.aton4('192.168.0.0'),i.aton4('192.168.255.255')]],u={firstIP:null,lastIP:null,lastLine:0,locationBuffer:null,locationRecordSize:88,mainBuffer:null,recordSize:24},d={firstIP:null,lastIP:null,lastLine:0,mainBuffer:null,recordSize:48};let y=JSON.parse(JSON.stringify(u)),S=JSON.parse(JSON.stringify(d));const p={range:'',country:'',region:'',eu:'',timezone:'',city:'',ll:[0,0]},B=e=>{let t,r,n=0,i=y.lastIP,a=y.lastLine,o=y.firstIP;const c=y.mainBuffer,s=y.locationBuffer,f=l,u=y.recordSize,d=y.locationRecordSize;let S;if(e>y.lastIP||e<y.firstIP)return null;for(S=0;S<f.length;S++)if(e>=f[S][0]&&e<=f[S][1])return null;for(;;){if(t=Math.round((a-n)/2)+n,i=c.readUInt32BE(t*u),o=c.readUInt32BE(t*u+4),i<=e&&o>=e)return p.range=[i,o],10===u?p.country=c.toString('utf8',t*u+8,t*u+10):(r=c.readUInt32BE(t*u+8),-1>>>0>r&&(p.country=s.toString('utf8',r*d,r*d+2).replace(/\u0000.*/,''),p.region=s.toString('utf8',r*d+2,r*d+5).replace(/\u0000.*/,''),p.metro=s.readInt32BE(r*d+5),p.ll[0]=c.readInt32BE(t*u+12)/1e4,p.ll[1]=c.readInt32BE(t*u+16)/1e4,p.area=c.readUInt32BE(t*u+20),p.eu=s.toString('utf8',r*d+9,r*d+10).replace(/\u0000.*/,''),p.timezone=s.toString('utf8',r*d+10,r*d+42).replace(/\u0000.*/,''),p.city=s.toString('utf8',r*d+42,r*d+d).replace(/\u0000.*/,''))),p;if(n===a)return null;n===a-1?t===n?n=a:a=n:i>e?a=t:o<e&&(n=t)}},I=['0:0:0:0:0:FFFF:','::FFFF:'];function g(t){let r,i;const a=JSON.parse(JSON.stringify(u));if('function'==typeof arguments[0])n.series([t=>{n.series([t=>{e.open(f.cityNames,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,a.locationBuffer=Buffer.alloc(i),t(e)}))},t=>{e.read(r,a.locationBuffer,0,i,0,t)},t=>{e.close(r,t)},t=>{e.open(f.city,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,t(e)}))}],(n=>{if(n){if('ENOENT'!==n.code&&'EBADF'!==n.code)throw n;e.open(f.country,'r',((n,o)=>{n?t(n):(r=o,e.fstat(r,((e,r)=>{i=r.size,a.recordSize=10,t()})))}))}else t()}))},()=>{a.mainBuffer=Buffer.alloc(i),n.series([t=>{e.read(r,a.mainBuffer,0,i,0,t)},t=>{e.close(r,t)}],(e=>{e||(a.lastLine=i/a.recordSize-1,a.lastIP=a.mainBuffer.readUInt32BE(a.lastLine*a.recordSize+4),a.firstIP=a.mainBuffer.readUInt32BE(0),y=a),t(e)}))}]);else{try{if(r=e.openSync(f.cityNames,'r'),i=e.fstatSync(r).size,0===i)throw{code:'EMPTY_FILE'};y.locationBuffer=Buffer.alloc(i),e.readSync(r,y.locationBuffer,0,i,0),e.closeSync(r),r=e.openSync(f.city,'r'),i=e.fstatSync(r).size}catch(t){if('ENOENT'!==t.code&&'EBADF'!==t.code&&'EMPTY_FILE'!==t.code)throw t;r=e.openSync(f.country,'r'),i=e.fstatSync(r).size,y.recordSize=10}y.mainBuffer=Buffer.alloc(i),e.readSync(r,y.mainBuffer,0,i,0),e.closeSync(r),y.lastLine=i/y.recordSize-1,y.lastIP=y.mainBuffer.readUInt32BE(y.lastLine*y.recordSize+4),y.firstIP=y.mainBuffer.readUInt32BE(0)}}function m(t){let r,i;const a=JSON.parse(JSON.stringify(d));if('function'==typeof arguments[0])n.series([t=>{n.series([t=>{e.open(f.city6,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,t(e)}))}],(n=>{if(n){if('ENOENT'!==n.code&&'EBADF'!==n.code)throw n;e.open(f.country6,'r',((n,o)=>{n?t(n):(r=o,e.fstat(r,((e,r)=>{i=r.size,a.recordSize=34,t()})))}))}else t()}))},()=>{a.mainBuffer=Buffer.alloc(i),n.series([t=>{e.read(r,a.mainBuffer,0,i,0,t)},t=>{e.close(r,t)}],(e=>{e||(a.lastLine=i/a.recordSize-1,S=a),t(e)}))}]);else{try{if(r=e.openSync(f.city6,'r'),i=e.fstatSync(r).size,0===i)throw{code:'EMPTY_FILE'}}catch(t){if('ENOENT'!==t.code&&'EBADF'!==t.code&&'EMPTY_FILE'!==t.code)throw t;r=e.openSync(f.country6,'r'),i=e.fstatSync(r).size,S.recordSize=34}S.mainBuffer=Buffer.alloc(i),e.readSync(r,S.mainBuffer,0,i,0),e.closeSync(r),S.lastLine=i/S.recordSize-1}}module.exports={cmp:i.cmp,lookup:e=>{if(!e)return null;if('number'==typeof e)return B(e);if(4===t.isIP(e))return B(i.aton4(e));if(6===t.isIP(e)){const t=(e=>{const t=e.toUpperCase();for(let e=0;e<I.length;e++){const r=I[e];if(0===t.indexOf(r))return t.substring(r.length)}return null})(e);return t?B(i.aton4(t)):(e=>{const t=S.mainBuffer,r=S.recordSize,n=y.locationBuffer,a=y.locationRecordSize,o=(e,n)=>{let i;const a=[];for(i=0;i<2;i++)a.push(t.readUInt32BE(e*r+16*n+4*i));return a};S.lastIP=o(S.lastLine,1),S.firstIP=o(0,0);let c,s,f=0,l=S.lastIP,u=S.lastLine,d=S.firstIP;if(i.cmp6(e,S.lastIP)>0||i.cmp6(e,S.firstIP)<0)return null;for(;;){if(c=Math.round((u-f)/2)+f,l=o(c,0),d=o(c,1),i.cmp6(l,e)<=0&&i.cmp6(d,e)>=0)return 34===r?p.country=t.toString('utf8',c*r+32,c*r+34).replace(/\u0000.*/,''):(s=t.readUInt32BE(c*r+32),-1>>>0>s&&(p.country=n.toString('utf8',s*a,s*a+2).replace(/\u0000.*/,''),p.region=n.toString('utf8',s*a+2,s*a+5).replace(/\u0000.*/,''),p.metro=n.readInt32BE(s*a+5),p.ll[0]=t.readInt32BE(c*r+36)/1e4,p.ll[1]=t.readInt32BE(c*r+40)/1e4,p.area=t.readUInt32BE(c*r+44),p.eu=n.toString('utf8',s*a+9,s*a+10).replace(/\u0000.*/,''),p.timezone=n.toString('utf8',s*a+10,s*a+42).replace(/\u0000.*/,''),p.city=n.toString('utf8',s*a+42,s*a+a).replace(/\u0000.*/,''))),p;if(f===u)return null;f===u-1?c===f?f=u:u=f:i.cmp6(l,e)>0?u=c:i.cmp6(d,e)<0&&(f=c)}})(i.aton6(e))}return null},pretty:e=>'string'==typeof e?e:'number'==typeof e?i.ntoa4(e):Array.isArray(e)?i.ntoa6(e):e,startWatchingDataUpdate:e=>{a.makeFsWatchFilter(c,s,6e4,(async()=>{await n.series([e=>{g(e)},e=>{m(e)}],e)}))},stopWatchingDataUpdate:()=>{a.stopWatching(c)},clear:()=>{y=JSON.parse(JSON.stringify(u)),S=JSON.parse(JSON.stringify(d))},reloadDataSync:()=>{g(),m()},reloadData:async e=>{await n.series([e=>{g(e)},e=>{m(e)}],e)},version:o},g(),m();