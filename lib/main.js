const{open:e,fstat:r,read:t,close:n,openSync:i,fstatSync:a,readSync:o,closeSync:l}=require('fs'),{isIP:c}=require('net'),{join:f,resolve:u}=require('path'),s=require('async'),{aton4:d,aton6:y,cmp6:B,ntoa4:p,ntoa6:S,cmp:g}=require('./utils.js'),I=require('./fsWatcher.js'),{version:E}=require('../package.json'),m='dataWatcher',z=u(__dirname,global.geoDataDir||process.env.GEODATADIR||'../geoip-data/'),N={city:f(z,'geoip-city.dat'),city6:f(z,'geoip-city6.dat'),cityNames:f(z,'geoip-city-names.dat'),country:f(z,'geoip-country.dat'),country6:f(z,'geoip-country6.dat')},P=[[d('10.0.0.0'),d('10.255.255.255')],[d('172.16.0.0'),d('172.31.255.255')],[d('192.168.0.0'),d('192.168.255.255')]],h={firstIP:null,lastIP:null,lastLine:0,locationBuffer:null,locationRecordSize:88,mainBuffer:null,recordSize:24},F={firstIP:null,lastIP:null,lastLine:0,mainBuffer:null,recordSize:48};let O=JSON.parse(JSON.stringify(h)),L=JSON.parse(JSON.stringify(F));const U=e=>{let r,t,n=0,i=O.lastIP,a=O.lastLine,o=O.firstIP;const l=O.mainBuffer,c=O.locationBuffer,f=P,u=O.recordSize,s=O.locationRecordSize,d={range:[null,null],country:'',region:'',eu:'',timezone:'',city:'',ll:[null,null]};if(e>O.lastIP||e<O.firstIP)return null;let y;for(y=0;y<f.length;y++)if(e>=f[y][0]&&e<=f[y][1])return null;for(;;){if(r=Math.round((a-n)/2)+n,i=l.readUInt32BE(r*u),o=l.readUInt32BE(r*u+4),i<=e&&o>=e)return d.range=[i,o],10===u?d.country=l.toString('utf8',r*u+8,r*u+10):(t=l.readUInt32BE(r*u+8),-1>>>0>t&&(d.country=c.toString('utf8',t*s,t*s+2).replace(/\u0000.*/,''),d.region=c.toString('utf8',t*s+2,t*s+5).replace(/\u0000.*/,''),d.metro=c.readInt32BE(t*s+5),d.ll[0]=l.readInt32BE(r*u+12)/1e4,d.ll[1]=l.readInt32BE(r*u+16)/1e4,d.area=l.readUInt32BE(r*u+20),d.eu=c.toString('utf8',t*s+9,t*s+10).replace(/\u0000.*/,''),d.timezone=c.toString('utf8',t*s+10,t*s+42).replace(/\u0000.*/,''),d.city=c.toString('utf8',t*s+42,t*s+s).replace(/\u0000.*/,''))),d;if(n===a)return null;n===a-1?r===n?n=a:a=n:i>e?a=r:o<e&&(n=r)}},D=['0:0:0:0:0:FFFF:','::FFFF:'];function J(c){let f,u;const d=JSON.parse(JSON.stringify(h));if('function'==typeof arguments[0])s.series([i=>{s.series([r=>{e(N.cityNames,'r',((e,t)=>{f=t,r(e)}))},e=>{r(f,((r,t)=>{u=t.size,d.locationBuffer=Buffer.alloc(u),e(r)}))},e=>{t(f,d.locationBuffer,0,u,0,e)},e=>{n(f,e)},r=>{e(N.city,'r',((e,t)=>{f=t,r(e)}))},e=>{r(f,((r,t)=>{u=t.size,e(r)}))}],(t=>{if(t){if('ENOENT'!==t.code&&'EBADF'!==t.code)throw t;e(N.country,'r',((e,t)=>{e?i(e):(f=t,r(f,((e,r)=>{u=r.size,d.recordSize=10,i()})))}))}else i()}))},()=>{d.mainBuffer=Buffer.alloc(u),s.series([e=>{t(f,d.mainBuffer,0,u,0,e)},e=>{n(f,e)}],(e=>{e||(d.lastLine=u/d.recordSize-1,d.lastIP=d.mainBuffer.readUInt32BE(d.lastLine*d.recordSize+4),d.firstIP=d.mainBuffer.readUInt32BE(0),O=d),c(e)}))}]);else{try{if(f=i(N.cityNames,'r'),u=a(f).size,0===u)throw{code:'EMPTY_FILE'};O.locationBuffer=Buffer.alloc(u),o(f,O.locationBuffer,0,u,0),l(f),f=i(N.city,'r'),u=a(f).size}catch(e){if('ENOENT'!==e.code&&'EBADF'!==e.code&&'EMPTY_FILE'!==e.code)throw e;f=i(N.country,'r'),u=a(f).size,O.recordSize=10}O.mainBuffer=Buffer.alloc(u),o(f,O.mainBuffer,0,u,0),l(f),O.lastLine=u/O.recordSize-1,O.lastIP=O.mainBuffer.readUInt32BE(O.lastLine*O.recordSize+4),O.firstIP=O.mainBuffer.readUInt32BE(0)}}function T(c){let f,u;const d=JSON.parse(JSON.stringify(F));if('function'==typeof arguments[0])s.series([t=>{s.series([r=>{e(N.city6,'r',((e,t)=>{f=t,r(e)}))},e=>{r(f,((r,t)=>{u=t.size,e(r)}))}],(n=>{if(n){if('ENOENT'!==n.code&&'EBADF'!==n.code)throw n;e(N.country6,'r',((e,n)=>{e?t(e):(f=n,r(f,((e,r)=>{u=r.size,d.recordSize=34,t()})))}))}else t()}))},()=>{d.mainBuffer=Buffer.alloc(u),s.series([e=>{t(f,d.mainBuffer,0,u,0,e)},e=>{n(f,e)}],(e=>{e||(d.lastLine=u/d.recordSize-1,L=d),c(e)}))}]);else{try{if(f=i(N.city6,'r'),u=a(f).size,0===u)throw{code:'EMPTY_FILE'}}catch(e){if('ENOENT'!==e.code&&'EBADF'!==e.code&&'EMPTY_FILE'!==e.code)throw e;f=i(N.country6,'r'),u=a(f).size,L.recordSize=34}L.mainBuffer=Buffer.alloc(u),o(f,L.mainBuffer,0,u,0),l(f),L.lastLine=u/L.recordSize-1}}module.exports={cmp:g,lookup:e=>{if(!e)return null;if('number'==typeof e)return U(e);if(4===c(e))return U(d(e));if(6===c(e)){const r=(e=>{const r=e.toUpperCase();for(let e=0;e<D.length;e++){const t=D[e];if(0===r.indexOf(t))return r.substring(t.length)}return null})(e);return r?U(d(r)):(e=>{const r=L.mainBuffer,t=L.recordSize,n=O.locationBuffer,i=O.locationRecordSize,a={range:[null,null],country:'',region:'',city:'',ll:[0,0]},o=(e,n)=>{let i;const a=[];for(i=0;i<2;i++)a.push(r.readUInt32BE(e*t+16*n+4*i));return a};L.lastIP=o(L.lastLine,1),L.firstIP=o(0,0);let l,c,f=0,u=L.lastIP,s=L.lastLine,d=L.firstIP;if(B(e,L.lastIP)>0||B(e,L.firstIP)<0)return null;for(;;){if(l=Math.round((s-f)/2)+f,u=o(l,0),d=o(l,1),B(u,e)<=0&&B(d,e)>=0)return 34===t?a.country=r.toString('utf8',l*t+32,l*t+34).replace(/\u0000.*/,''):(c=r.readUInt32BE(l*t+32),-1>>>0>c&&(a.country=n.toString('utf8',c*i,c*i+2).replace(/\u0000.*/,''),a.region=n.toString('utf8',c*i+2,c*i+5).replace(/\u0000.*/,''),a.metro=n.readInt32BE(c*i+5),a.ll[0]=r.readInt32BE(l*t+36)/1e4,a.ll[1]=r.readInt32BE(l*t+40)/1e4,a.area=r.readUInt32BE(l*t+44),a.eu=n.toString('utf8',c*i+9,c*i+10).replace(/\u0000.*/,''),a.timezone=n.toString('utf8',c*i+10,c*i+42).replace(/\u0000.*/,''),a.city=n.toString('utf8',c*i+42,c*i+i).replace(/\u0000.*/,''))),a;if(f===s)return null;f===s-1?l===f?f=s:s=f:B(u,e)>0?s=l:B(d,e)<0&&(f=l)}})(y(e))}return null},pretty:e=>'string'==typeof e?e:'number'==typeof e?p(e):Array.isArray(e)?S(e):e,startWatchingDataUpdate:e=>{I.makeFsWatchFilter(m,z,6e4,(async()=>{await s.series([e=>{J(e)},e=>{T(e)}],e)}))},stopWatchingDataUpdate:()=>I.stopWatching(m),clear:()=>{O=JSON.parse(JSON.stringify(h)),L=JSON.parse(JSON.stringify(F))},reloadDataSync:()=>{J(),T()},reloadData:async e=>{await s.series([e=>{J(e)},e=>{T(e)}],e)},version:E},J(),T();