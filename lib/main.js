const e=require('fs'),{isIP:t}=require('net'),r=require('path'),n=require('async'),{aton4:i,aton6:o,cmp6:a,ntoa4:c,ntoa6:l,cmp:f}=require('./utils.js'),s=require('./fsWatcher.js'),{version:u}=require('../package.json');e.existsSync=e.existsSync||r.existsSync;const y='dataWatcher',d=r.resolve(__dirname,global.geoDataDir||process.env.GEODATADIR||'../geoip-data/'),S={city:r.join(d,'geoip-city.dat'),city6:r.join(d,'geoip-city6.dat'),cityNames:r.join(d,'geoip-city-names.dat'),country:r.join(d,'geoip-country.dat'),country6:r.join(d,'geoip-country6.dat')},p=[[i('10.0.0.0'),i('10.255.255.255')],[i('172.16.0.0'),i('172.31.255.255')],[i('192.168.0.0'),i('192.168.255.255')]],B={firstIP:null,lastIP:null,lastLine:0,locationBuffer:null,locationRecordSize:88,mainBuffer:null,recordSize:24},g={firstIP:null,lastIP:null,lastLine:0,mainBuffer:null,recordSize:48};let I=JSON.parse(JSON.stringify(B)),E=JSON.parse(JSON.stringify(g));const m=e=>{let t,r,n=0,i=I.lastIP,o=I.lastLine,a=I.firstIP;const c=I.mainBuffer,l=I.locationBuffer,f=p,s=I.recordSize,u=I.locationRecordSize,y={range:[null,null],country:'',region:'',eu:'',timezone:'',city:'',ll:[null,null]};if(e>I.lastIP||e<I.firstIP)return null;let d;for(d=0;d<f.length;d++)if(e>=f[d][0]&&e<=f[d][1])return null;for(;;){if(t=Math.round((o-n)/2)+n,i=c.readUInt32BE(t*s),a=c.readUInt32BE(t*s+4),i<=e&&a>=e)return y.range=[i,a],10===s?y.country=c.toString('utf8',t*s+8,t*s+10):(r=c.readUInt32BE(t*s+8),-1>>>0>r&&(y.country=l.toString('utf8',r*u,r*u+2).replace(/\u0000.*/,''),y.region=l.toString('utf8',r*u+2,r*u+5).replace(/\u0000.*/,''),y.metro=l.readInt32BE(r*u+5),y.ll[0]=c.readInt32BE(t*s+12)/1e4,y.ll[1]=c.readInt32BE(t*s+16)/1e4,y.area=c.readUInt32BE(t*s+20),y.eu=l.toString('utf8',r*u+9,r*u+10).replace(/\u0000.*/,''),y.timezone=l.toString('utf8',r*u+10,r*u+42).replace(/\u0000.*/,''),y.city=l.toString('utf8',r*u+42,r*u+u).replace(/\u0000.*/,''))),y;if(n===o)return null;n===o-1?t===n?n=o:o=n:i>e?o=t:a<e&&(n=t)}},z=['0:0:0:0:0:FFFF:','::FFFF:'];function N(t){let r,i;const o=JSON.parse(JSON.stringify(B));if('function'==typeof arguments[0])n.series([t=>{n.series([t=>{e.open(S.cityNames,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,o.locationBuffer=Buffer.alloc(i),t(e)}))},t=>{e.read(r,o.locationBuffer,0,i,0,t)},t=>{e.close(r,t)},t=>{e.open(S.city,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,t(e)}))}],(n=>{if(n){if('ENOENT'!==n.code&&'EBADF'!==n.code)throw n;e.open(S.country,'r',((n,a)=>{n?t(n):(r=a,e.fstat(r,((e,r)=>{i=r.size,o.recordSize=10,t()})))}))}else t()}))},()=>{o.mainBuffer=Buffer.alloc(i),n.series([t=>{e.read(r,o.mainBuffer,0,i,0,t)},t=>{e.close(r,t)}],(e=>{e||(o.lastLine=i/o.recordSize-1,o.lastIP=o.mainBuffer.readUInt32BE(o.lastLine*o.recordSize+4),o.firstIP=o.mainBuffer.readUInt32BE(0),I=o),t(e)}))}]);else{try{if(r=e.openSync(S.cityNames,'r'),i=e.fstatSync(r).size,0===i)throw{code:'EMPTY_FILE'};I.locationBuffer=Buffer.alloc(i),e.readSync(r,I.locationBuffer,0,i,0),e.closeSync(r),r=e.openSync(S.city,'r'),i=e.fstatSync(r).size}catch(t){if('ENOENT'!==t.code&&'EBADF'!==t.code&&'EMPTY_FILE'!==t.code)throw t;r=e.openSync(S.country,'r'),i=e.fstatSync(r).size,I.recordSize=10}I.mainBuffer=Buffer.alloc(i),e.readSync(r,I.mainBuffer,0,i,0),e.closeSync(r),I.lastLine=i/I.recordSize-1,I.lastIP=I.mainBuffer.readUInt32BE(I.lastLine*I.recordSize+4),I.firstIP=I.mainBuffer.readUInt32BE(0)}}function P(t){let r,i;const o=JSON.parse(JSON.stringify(g));if('function'==typeof arguments[0])n.series([t=>{n.series([t=>{e.open(S.city6,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,t(e)}))}],(n=>{if(n){if('ENOENT'!==n.code&&'EBADF'!==n.code)throw n;e.open(S.country6,'r',((n,a)=>{n?t(n):(r=a,e.fstat(r,((e,r)=>{i=r.size,o.recordSize=34,t()})))}))}else t()}))},()=>{o.mainBuffer=Buffer.alloc(i),n.series([t=>{e.read(r,o.mainBuffer,0,i,0,t)},t=>{e.close(r,t)}],(e=>{e||(o.lastLine=i/o.recordSize-1,E=o),t(e)}))}]);else{try{if(r=e.openSync(S.city6,'r'),i=e.fstatSync(r).size,0===i)throw{code:'EMPTY_FILE'}}catch(t){if('ENOENT'!==t.code&&'EBADF'!==t.code&&'EMPTY_FILE'!==t.code)throw t;r=e.openSync(S.country6,'r'),i=e.fstatSync(r).size,E.recordSize=34}E.mainBuffer=Buffer.alloc(i),e.readSync(r,E.mainBuffer,0,i,0),e.closeSync(r),E.lastLine=i/E.recordSize-1}}module.exports={cmp:f,lookup:e=>{if(!e)return null;if('number'==typeof e)return m(e);if(4===t(e))return m(i(e));if(6===t(e)){const t=(e=>{const t=e.toUpperCase();for(let e=0;e<z.length;e++){const r=z[e];if(0===t.indexOf(r))return t.substring(r.length)}return null})(e);return t?m(i(t)):(e=>{const t=E.mainBuffer,r=E.recordSize,n=I.locationBuffer,i=I.locationRecordSize,o={range:[null,null],country:'',region:'',city:'',ll:[0,0]},c=(e,n)=>{let i;const o=[];for(i=0;i<2;i++)o.push(t.readUInt32BE(e*r+16*n+4*i));return o};E.lastIP=c(E.lastLine,1),E.firstIP=c(0,0);let l,f,s=0,u=E.lastIP,y=E.lastLine,d=E.firstIP;if(a(e,E.lastIP)>0||a(e,E.firstIP)<0)return null;for(;;){if(l=Math.round((y-s)/2)+s,u=c(l,0),d=c(l,1),a(u,e)<=0&&a(d,e)>=0)return 34===r?o.country=t.toString('utf8',l*r+32,l*r+34).replace(/\u0000.*/,''):(f=t.readUInt32BE(l*r+32),-1>>>0>f&&(o.country=n.toString('utf8',f*i,f*i+2).replace(/\u0000.*/,''),o.region=n.toString('utf8',f*i+2,f*i+5).replace(/\u0000.*/,''),o.metro=n.readInt32BE(f*i+5),o.ll[0]=t.readInt32BE(l*r+36)/1e4,o.ll[1]=t.readInt32BE(l*r+40)/1e4,o.area=t.readUInt32BE(l*r+44),o.eu=n.toString('utf8',f*i+9,f*i+10).replace(/\u0000.*/,''),o.timezone=n.toString('utf8',f*i+10,f*i+42).replace(/\u0000.*/,''),o.city=n.toString('utf8',f*i+42,f*i+i).replace(/\u0000.*/,''))),o;if(s===y)return null;s===y-1?l===s?s=y:y=s:a(u,e)>0?y=l:a(d,e)<0&&(s=l)}})(o(e))}return null},pretty:e=>'string'==typeof e?e:'number'==typeof e?c(e):Array.isArray(e)?l(e):e,startWatchingDataUpdate:e=>{s.makeFsWatchFilter(y,d,6e4,(async()=>{await n.series([e=>{N(e)},e=>{P(e)}],e)}))},stopWatchingDataUpdate:()=>s.stopWatching(y),clear:()=>{I=JSON.parse(JSON.stringify(B)),E=JSON.parse(JSON.stringify(g))},reloadDataSync:()=>{N(),P()},reloadData:async e=>{await n.series([e=>{N(e)},e=>{P(e)}],e)},version:u},N(),P();