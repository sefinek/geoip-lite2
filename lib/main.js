const e=require('fs'),{isIP:t}=require('net'),r=require('path'),n=require('async'),{aton4:i,aton6:a,cmp6:o,ntoa4:c,ntoa6:f,cmp:s}=require('./utils.js'),l=require('./fsWatcher.js'),{version:u}=require('../package.json');e.existsSync=e.existsSync||r.existsSync;const d='dataWatcher',y=r.resolve(__dirname,global.geoDataDir||process.env.geoDataDIR||'../data/'),S={city:r.join(y,'geoip-city.dat'),city6:r.join(y,'geoip-city6.dat'),cityNames:r.join(y,'geoip-city-names.dat'),country:r.join(y,'geoip-country.dat'),country6:r.join(y,'geoip-country6.dat')},p=[[i('10.0.0.0'),i('10.255.255.255')],[i('172.16.0.0'),i('172.31.255.255')],[i('192.168.0.0'),i('192.168.255.255')]],B={firstIP:null,lastIP:null,lastLine:0,locationBuffer:null,locationRecordSize:88,mainBuffer:null,recordSize:24},I={firstIP:null,lastIP:null,lastLine:0,mainBuffer:null,recordSize:48};let g=JSON.parse(JSON.stringify(B)),E=JSON.parse(JSON.stringify(I));const m={range:'',country:'',region:'',eu:'',timezone:'',city:'',ll:[0,0]},z=e=>{let t,r,n=0,i=g.lastIP,a=g.lastLine,o=g.firstIP;const c=g.mainBuffer,f=g.locationBuffer,s=p,l=g.recordSize,u=g.locationRecordSize;let d;if(e>g.lastIP||e<g.firstIP)return null;for(d=0;d<s.length;d++)if(e>=s[d][0]&&e<=s[d][1])return null;for(;;){if(t=Math.round((a-n)/2)+n,i=c.readUInt32BE(t*l),o=c.readUInt32BE(t*l+4),i<=e&&o>=e)return m.range=[i,o],10===l?m.country=c.toString('utf8',t*l+8,t*l+10):(r=c.readUInt32BE(t*l+8),-1>>>0>r&&(m.country=f.toString('utf8',r*u,r*u+2).replace(/\u0000.*/,''),m.region=f.toString('utf8',r*u+2,r*u+5).replace(/\u0000.*/,''),m.metro=f.readInt32BE(r*u+5),m.ll[0]=c.readInt32BE(t*l+12)/1e4,m.ll[1]=c.readInt32BE(t*l+16)/1e4,m.area=c.readUInt32BE(t*l+20),m.eu=f.toString('utf8',r*u+9,r*u+10).replace(/\u0000.*/,''),m.timezone=f.toString('utf8',r*u+10,r*u+42).replace(/\u0000.*/,''),m.city=f.toString('utf8',r*u+42,r*u+u).replace(/\u0000.*/,''))),m;if(n===a)return null;n===a-1?t===n?n=a:a=n:i>e?a=t:o<e&&(n=t)}},N=['0:0:0:0:0:FFFF:','::FFFF:'];function P(t){let r,i;const a=JSON.parse(JSON.stringify(B));if('function'==typeof arguments[0])n.series([t=>{n.series([t=>{e.open(S.cityNames,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,a.locationBuffer=Buffer.alloc(i),t(e)}))},t=>{e.read(r,a.locationBuffer,0,i,0,t)},t=>{e.close(r,t)},t=>{e.open(S.city,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,t(e)}))}],(n=>{if(n){if('ENOENT'!==n.code&&'EBADF'!==n.code)throw n;e.open(S.country,'r',((n,o)=>{n?t(n):(r=o,e.fstat(r,((e,r)=>{i=r.size,a.recordSize=10,t()})))}))}else t()}))},()=>{a.mainBuffer=Buffer.alloc(i),n.series([t=>{e.read(r,a.mainBuffer,0,i,0,t)},t=>{e.close(r,t)}],(e=>{e||(a.lastLine=i/a.recordSize-1,a.lastIP=a.mainBuffer.readUInt32BE(a.lastLine*a.recordSize+4),a.firstIP=a.mainBuffer.readUInt32BE(0),g=a),t(e)}))}]);else{try{if(r=e.openSync(S.cityNames,'r'),i=e.fstatSync(r).size,0===i)throw{code:'EMPTY_FILE'};g.locationBuffer=Buffer.alloc(i),e.readSync(r,g.locationBuffer,0,i,0),e.closeSync(r),r=e.openSync(S.city,'r'),i=e.fstatSync(r).size}catch(t){if('ENOENT'!==t.code&&'EBADF'!==t.code&&'EMPTY_FILE'!==t.code)throw t;r=e.openSync(S.country,'r'),i=e.fstatSync(r).size,g.recordSize=10}g.mainBuffer=Buffer.alloc(i),e.readSync(r,g.mainBuffer,0,i,0),e.closeSync(r),g.lastLine=i/g.recordSize-1,g.lastIP=g.mainBuffer.readUInt32BE(g.lastLine*g.recordSize+4),g.firstIP=g.mainBuffer.readUInt32BE(0)}}function h(t){let r,i;const a=JSON.parse(JSON.stringify(I));if('function'==typeof arguments[0])n.series([t=>{n.series([t=>{e.open(S.city6,'r',((e,n)=>{r=n,t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size,t(e)}))}],(n=>{if(n){if('ENOENT'!==n.code&&'EBADF'!==n.code)throw n;e.open(S.country6,'r',((n,o)=>{n?t(n):(r=o,e.fstat(r,((e,r)=>{i=r.size,a.recordSize=34,t()})))}))}else t()}))},()=>{a.mainBuffer=Buffer.alloc(i),n.series([t=>{e.read(r,a.mainBuffer,0,i,0,t)},t=>{e.close(r,t)}],(e=>{e||(a.lastLine=i/a.recordSize-1,E=a),t(e)}))}]);else{try{if(r=e.openSync(S.city6,'r'),i=e.fstatSync(r).size,0===i)throw{code:'EMPTY_FILE'}}catch(t){if('ENOENT'!==t.code&&'EBADF'!==t.code&&'EMPTY_FILE'!==t.code)throw t;r=e.openSync(S.country6,'r'),i=e.fstatSync(r).size,E.recordSize=34}E.mainBuffer=Buffer.alloc(i),e.readSync(r,E.mainBuffer,0,i,0),e.closeSync(r),E.lastLine=i/E.recordSize-1}}module.exports={cmp:s,lookup:e=>{if(!e)return null;if('number'==typeof e)return z(e);if(4===t(e))return z(i(e));if(6===t(e)){const t=(e=>{const t=e.toUpperCase();for(let e=0;e<N.length;e++){const r=N[e];if(0===t.indexOf(r))return t.substring(r.length)}return null})(e);return t?z(i(t)):(e=>{const t=E.mainBuffer,r=E.recordSize,n=g.locationBuffer,i=g.locationRecordSize,a=(e,n)=>{let i;const a=[];for(i=0;i<2;i++)a.push(t.readUInt32BE(e*r+16*n+4*i));return a};E.lastIP=a(E.lastLine,1),E.firstIP=a(0,0);let c,f,s=0,l=E.lastIP,u=E.lastLine,d=E.firstIP;if(o(e,E.lastIP)>0||o(e,E.firstIP)<0)return null;for(;;){if(c=Math.round((u-s)/2)+s,l=a(c,0),d=a(c,1),o(l,e)<=0&&o(d,e)>=0)return 34===r?m.country=t.toString('utf8',c*r+32,c*r+34).replace(/\u0000.*/,''):(f=t.readUInt32BE(c*r+32),-1>>>0>f&&(m.country=n.toString('utf8',f*i,f*i+2).replace(/\u0000.*/,''),m.region=n.toString('utf8',f*i+2,f*i+5).replace(/\u0000.*/,''),m.metro=n.readInt32BE(f*i+5),m.ll[0]=t.readInt32BE(c*r+36)/1e4,m.ll[1]=t.readInt32BE(c*r+40)/1e4,m.area=t.readUInt32BE(c*r+44),m.eu=n.toString('utf8',f*i+9,f*i+10).replace(/\u0000.*/,''),m.timezone=n.toString('utf8',f*i+10,f*i+42).replace(/\u0000.*/,''),m.city=n.toString('utf8',f*i+42,f*i+i).replace(/\u0000.*/,''))),m;if(s===u)return null;s===u-1?c===s?s=u:u=s:o(l,e)>0?u=c:o(d,e)<0&&(s=c)}})(a(e))}return null},pretty:e=>'string'==typeof e?e:'number'==typeof e?c(e):Array.isArray(e)?f(e):e,startWatchingDataUpdate:e=>{l.makeFsWatchFilter(d,y,6e4,(async()=>{await n.series([e=>{P(e)},e=>{h(e)}],e)}))},stopWatchingDataUpdate:()=>{l.stopWatching(d)},clear:()=>{g=JSON.parse(JSON.stringify(B)),E=JSON.parse(JSON.stringify(I))},reloadDataSync:()=>{P(),h()},reloadData:async e=>{await n.series([e=>{P(e)},e=>{h(e)}],e)},version:u},P(),h();