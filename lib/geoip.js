const e=require('node:fs');const t=require('node:net');const r=require('node:path');const n=require('async');const i=require('./utils.js');const o=require('./fsWatcher.js');const{version:s}=require('../package.json');e.existsSync=e.existsSync||r.existsSync;const c='dataWatcher';const a=r.resolve(__dirname,global.geoDataDir||process.env.geoDataDIR||'../data/');const l={city:r.join(a,'geoip-city.dat'),city6:r.join(a,'geoip-city6.dat'),cityNames:r.join(a,'geoip-city-names.dat'),country:r.join(a,'geoip-country.dat'),country6:r.join(a,'geoip-country6.dat')};const f=[[i.aton4('10.0.0.0'),i.aton4('10.255.255.255')],[i.aton4('172.16.0.0'),i.aton4('172.31.255.255')],[i.aton4('192.168.0.0'),i.aton4('192.168.255.255')]];const u={firstIP:null,lastIP:null,lastLine:0,locationBuffer:null,locationRecordSize:88,mainBuffer:null,recordSize:24};const d={firstIP:null,lastIP:null,lastLine:0,mainBuffer:null,recordSize:48};let y=JSON.parse(JSON.stringify(u));let S=JSON.parse(JSON.stringify(d));const p=10;const B=34;const g=e=>{let t=0;let r=y.lastIP;let n=y.lastLine;let i=y.firstIP;let o;let s;const c=y.mainBuffer;const a=y.locationBuffer;const l=f;const u=y.recordSize;const d=y.locationRecordSize;let S;const B={range:'',country:'',region:'',eu:'',timezone:'',city:'',ll:[0,0]};if(e>y.lastIP||e<y.firstIP){return null}for(S=0;S<l.length;S++){if(e>=l[S][0]&&e<=l[S][1]){return null}}do{o=Math.round((n-t)/2)+t;r=c.readUInt32BE(o*u);i=c.readUInt32BE(o*u+4);if(r<=e&&i>=e){B.range=[r,i];if(u===p){B.country=c.toString('utf8',o*u+8,o*u+10)}else{s=c.readUInt32BE(o*u+8);B.country=a.toString('utf8',s*d,s*d+2).replace(/\u0000.*/,'');B.region=a.toString('utf8',s*d+2,s*d+5).replace(/\u0000.*/,'');B.metro=a.readInt32BE(s*d+5);B.ll[0]=c.readInt32BE(o*u+12)/1e4;B.ll[1]=c.readInt32BE(o*u+16)/1e4;B.area=c.readUInt32BE(o*u+20);B.eu=a.toString('utf8',s*d+9,s*d+10).replace(/\u0000.*/,'');B.timezone=a.toString('utf8',s*d+10,s*d+42).replace(/\u0000.*/,'');B.city=a.toString('utf8',s*d+42,s*d+d).replace(/\u0000.*/,'')}return B}else if(t===n){return null}else if(t===n-1){if(o===t){t=n}else{n=t}}else if(r>e){n=o}else if(i<e){t=o}}while(1)};const I=e=>{const t=S.mainBuffer;const r=S.recordSize;const n=y.locationBuffer;const o=y.locationRecordSize;const s={range:'',country:'',region:'',city:'',ll:[0,0]};const c=(e,n)=>{let i=0;const o=[];for(i=0;i<2;i++){o.push(t.readUInt32BE(e*r+n*16+i*4))}return o};S.lastIP=c(S.lastLine,1);S.firstIP=c(0,0);let a=0;let l=S.lastIP;let f=S.lastLine;let u=S.firstIP;let d;let p;if(i.cmp6(e,S.lastIP)>0||i.cmp6(e,S.firstIP)<0){return null}do{d=Math.round((f-a)/2)+a;l=c(d,0);u=c(d,1);if(i.cmp6(l,e)<=0&&i.cmp6(u,e)>=0){if(r===B){s.country=t.toString('utf8',d*r+32,d*r+34).replace(/\u0000.*/,'')}else{p=t.readUInt32BE(d*r+32);s.country=n.toString('utf8',p*o,p*o+2).replace(/\u0000.*/,'');s.region=n.toString('utf8',p*o+2,p*o+5).replace(/\u0000.*/,'');s.metro=n.readInt32BE(p*o+5);s.ll[0]=t.readInt32BE(d*r+36)/1e4;s.ll[1]=t.readInt32BE(d*r+40)/1e4;s.area=t.readUInt32BE(d*r+44);s.eu=n.toString('utf8',p*o+9,p*o+10).replace(/\u0000.*/,'');s.timezone=n.toString('utf8',p*o+10,p*o+42).replace(/\u0000.*/,'');s.city=n.toString('utf8',p*o+42,p*o+o).replace(/\u0000.*/,'')}return s}else if(a===f){return null}else if(a===f-1){if(d===a){a=f}else{f=a}}else if(i.cmp6(l,e)>0){f=d}else if(i.cmp6(u,e)<0){a=d}}while(1)};const m=e=>{const t=e.toUpperCase();const r=['0:0:0:0:0:FFFF:','::FFFF:'];for(let e=0;e<r.length;e++){const n=r[e];if(t.indexOf(n)===0){return t.substring(n.length)}}return null};function E(t){let r;let i;const o=JSON.parse(JSON.stringify(u));if(typeof arguments[0]==='function'){n.series([t=>{n.series([t=>{e.open(l.cityNames,'r',((e,n)=>{r=n;t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size;o.locationBuffer=Buffer.alloc(i);t(e)}))},t=>{e.read(r,o.locationBuffer,0,i,0,t)},t=>{e.close(r,t)},t=>{e.open(l.city,'r',((e,n)=>{r=n;t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size;t(e)}))}],(n=>{if(n){if(n.code!=='ENOENT'&&n.code!=='EBADF'){throw n}e.open(l.country,'r',((n,s)=>{if(n){t(n)}else{r=s;e.fstat(r,((e,r)=>{i=r.size;o.recordSize=p;t()}))}}))}else{t()}}))},()=>{o.mainBuffer=Buffer.alloc(i);n.series([t=>{e.read(r,o.mainBuffer,0,i,0,t)},t=>{e.close(r,t)}],(e=>{if(e){}else{o.lastLine=i/o.recordSize-1;o.lastIP=o.mainBuffer.readUInt32BE(o.lastLine*o.recordSize+4);o.firstIP=o.mainBuffer.readUInt32BE(0);y=o}t(e)}))}])}else{try{r=e.openSync(l.cityNames,'r');i=e.fstatSync(r).size;if(i===0){throw{code:'EMPTY_FILE'}}y.locationBuffer=Buffer.alloc(i);e.readSync(r,y.locationBuffer,0,i,0);e.closeSync(r);r=e.openSync(l.city,'r');i=e.fstatSync(r).size}catch(t){if(t.code!=='ENOENT'&&t.code!=='EBADF'&&t.code!=='EMPTY_FILE'){throw t}r=e.openSync(l.country,'r');i=e.fstatSync(r).size;y.recordSize=p}y.mainBuffer=Buffer.alloc(i);e.readSync(r,y.mainBuffer,0,i,0);e.closeSync(r);y.lastLine=i/y.recordSize-1;y.lastIP=y.mainBuffer.readUInt32BE(y.lastLine*y.recordSize+4);y.firstIP=y.mainBuffer.readUInt32BE(0)}}function z(t){let r;let i;const o=JSON.parse(JSON.stringify(d));if(typeof arguments[0]==='function'){n.series([t=>{n.series([t=>{e.open(l.city6,'r',((e,n)=>{r=n;t(e)}))},t=>{e.fstat(r,((e,r)=>{i=r.size;t(e)}))}],(n=>{if(n){if(n.code!=='ENOENT'&&n.code!=='EBADF'){throw n}e.open(l.country6,'r',((n,s)=>{if(n){t(n)}else{r=s;e.fstat(r,((e,r)=>{i=r.size;o.recordSize=B;t()}))}}))}else{t()}}))},()=>{o.mainBuffer=Buffer.alloc(i);n.series([t=>{e.read(r,o.mainBuffer,0,i,0,t)},t=>{e.close(r,t)}],(e=>{if(e){}else{o.lastLine=i/o.recordSize-1;S=o}t(e)}))}])}else{try{r=e.openSync(l.city6,'r');i=e.fstatSync(r).size;if(i===0){throw{code:'EMPTY_FILE'}}}catch(t){if(t.code!=='ENOENT'&&t.code!=='EBADF'&&t.code!=='EMPTY_FILE'){throw t}r=e.openSync(l.country6,'r');i=e.fstatSync(r).size;S.recordSize=B}S.mainBuffer=Buffer.alloc(i);e.readSync(r,S.mainBuffer,0,i,0);e.closeSync(r);S.lastLine=i/S.recordSize-1}}module.exports={cmp:i.cmp,lookup:e=>{if(!e){return null}else if(typeof e==='number'){return g(e)}else if(t.isIP(e)===4){return g(i.aton4(e))}else if(t.isIP(e)===6){const t=m(e);if(t){return g(i.aton4(t))}else{return I(i.aton6(e))}}return null},pretty:e=>{if(typeof e==='string'){return e}else if(typeof e==='number'){return i.ntoa4(e)}else if(Array.isArray(e)){return i.ntoa6(e)}return e},startWatchingDataUpdate:e=>{o.makeFsWatchFilter(c,a,60*1e3,(()=>{n.series([e=>{E(e)},e=>{z(e)}],e)}))},stopWatchingDataUpdate:()=>{o.stopWatching(c)},clear:()=>{y=JSON.parse(JSON.stringify(u));S=JSON.parse(JSON.stringify(d))},reloadDataSync:()=>{E();z()},reloadData:e=>{n.series([e=>{E(e)},e=>{z(e)}],e)},version:s};E();z();