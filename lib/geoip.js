const fs=require("node:fs"),net=require("node:net"),path=require("node:path"),async=require("async"),utils=require("./utils.js"),fsWatcher=require("./fsWatcher.js"),{version:version}=require("../package.json");fs.existsSync=fs.existsSync||path.existsSync;const watcherName="dataWatcher",geoDataDir=path.resolve(__dirname,global.geoDataDir||process.env.geoDataDIR||"../data/"),dataFiles={city:path.join(geoDataDir,"geoip-city.dat"),city6:path.join(geoDataDir,"geoip-city6.dat"),cityNames:path.join(geoDataDir,"geoip-city-names.dat"),country:path.join(geoDataDir,"geoip-country.dat"),country6:path.join(geoDataDir,"geoip-country6.dat")},privateRange4=[[utils.aton4("10.0.0.0"),utils.aton4("10.255.255.255")],[utils.aton4("172.16.0.0"),utils.aton4("172.31.255.255")],[utils.aton4("192.168.0.0"),utils.aton4("192.168.255.255")]],conf4={firstIP:null,lastIP:null,lastLine:0,locationBuffer:null,locationRecordSize:88,mainBuffer:null,recordSize:24},conf6={firstIP:null,lastIP:null,lastLine:0,mainBuffer:null,recordSize:48};let cache4=JSON.parse(JSON.stringify(conf4)),cache6=JSON.parse(JSON.stringify(conf6));const RECORD_SIZE=10,RECORD_SIZE6=34,lookup4=e=>{let t,a,r=0,c=cache4.lastIP,n=cache4.lastLine,i=cache4.firstIP;const o=cache4.mainBuffer,s=cache4.locationBuffer,f=privateRange4,l=cache4.recordSize,u=cache4.locationRecordSize;let d;const p={range:"",country:"",region:"",eu:"",timezone:"",city:"",ll:[0,0]};if(e>cache4.lastIP||e<cache4.firstIP)return null;for(d=0;d<f.length;d++)if(e>=f[d][0]&&e<=f[d][1])return null;for(;;){if(t=Math.round((n-r)/2)+r,c=o.readUInt32BE(t*l),i=o.readUInt32BE(t*l+4),c<=e&&i>=e)return p.range=[c,i],10===l?p.country=o.toString("utf8",t*l+8,t*l+10):(a=o.readUInt32BE(t*l+8),p.country=s.toString("utf8",a*u,a*u+2).replace(/\u0000.*/,""),p.region=s.toString("utf8",a*u+2,a*u+5).replace(/\u0000.*/,""),p.metro=s.readInt32BE(a*u+5),p.ll[0]=o.readInt32BE(t*l+12)/1e4,p.ll[1]=o.readInt32BE(t*l+16)/1e4,p.area=o.readUInt32BE(t*l+20),p.eu=s.toString("utf8",a*u+9,a*u+10).replace(/\u0000.*/,""),p.timezone=s.toString("utf8",a*u+10,a*u+42).replace(/\u0000.*/,""),p.city=s.toString("utf8",a*u+42,a*u+u).replace(/\u0000.*/,"")),p;if(r===n)return null;r===n-1?t===r?r=n:n=r:c>e?n=t:i<e&&(r=t)}},lookup6=e=>{const t=cache6.mainBuffer,a=cache6.recordSize,r=cache4.locationBuffer,c=cache4.locationRecordSize,n={range:"",country:"",region:"",city:"",ll:[0,0]},i=(e,r)=>{let c=0;const n=[];for(c=0;c<2;c++)n.push(t.readUInt32BE(e*a+16*r+4*c));return n};cache6.lastIP=i(cache6.lastLine,1),cache6.firstIP=i(0,0);let o,s,f=0,l=cache6.lastIP,u=cache6.lastLine,d=cache6.firstIP;if(utils.cmp6(e,cache6.lastIP)>0||utils.cmp6(e,cache6.firstIP)<0)return null;for(;;){if(o=Math.round((u-f)/2)+f,l=i(o,0),d=i(o,1),utils.cmp6(l,e)<=0&&utils.cmp6(d,e)>=0)return 34===a?n.country=t.toString("utf8",o*a+32,o*a+34).replace(/\u0000.*/,""):(s=t.readUInt32BE(o*a+32),n.country=r.toString("utf8",s*c,s*c+2).replace(/\u0000.*/,""),n.region=r.toString("utf8",s*c+2,s*c+5).replace(/\u0000.*/,""),n.metro=r.readInt32BE(s*c+5),n.ll[0]=t.readInt32BE(o*a+36)/1e4,n.ll[1]=t.readInt32BE(o*a+40)/1e4,n.area=t.readUInt32BE(o*a+44),n.eu=r.toString("utf8",s*c+9,s*c+10).replace(/\u0000.*/,""),n.timezone=r.toString("utf8",s*c+10,s*c+42).replace(/\u0000.*/,""),n.city=r.toString("utf8",s*c+42,s*c+c).replace(/\u0000.*/,"")),n;if(f===u)return null;f===u-1?o===f?f=u:u=f:utils.cmp6(l,e)>0?u=o:utils.cmp6(d,e)<0&&(f=o)}},get4mapped=e=>{const t=e.toUpperCase(),a=["0:0:0:0:0:FFFF:","::FFFF:"];for(let e=0;e<a.length;e++){const r=a[e];if(0===t.indexOf(r))return t.substring(r.length)}return null};function preload(e){let t,a;const r=JSON.parse(JSON.stringify(conf4));if("function"==typeof arguments[0])async.series([e=>{async.series([e=>{fs.open(dataFiles.cityNames,"r",((a,r)=>{t=r,e(a)}))},e=>{fs.fstat(t,((t,c)=>{a=c.size,r.locationBuffer=Buffer.alloc(a),e(t)}))},e=>{fs.read(t,r.locationBuffer,0,a,0,e)},e=>{fs.close(t,e)},e=>{fs.open(dataFiles.city,"r",((a,r)=>{t=r,e(a)}))},e=>{fs.fstat(t,((t,r)=>{a=r.size,e(t)}))}],(c=>{if(c){if("ENOENT"!==c.code&&"EBADF"!==c.code)throw c;fs.open(dataFiles.country,"r",((c,n)=>{c?e(c):(t=n,fs.fstat(t,((t,c)=>{a=c.size,r.recordSize=10,e()})))}))}else e()}))},()=>{r.mainBuffer=Buffer.alloc(a),async.series([e=>{fs.read(t,r.mainBuffer,0,a,0,e)},e=>{fs.close(t,e)}],(t=>{t||(r.lastLine=a/r.recordSize-1,r.lastIP=r.mainBuffer.readUInt32BE(r.lastLine*r.recordSize+4),r.firstIP=r.mainBuffer.readUInt32BE(0),cache4=r),e(t)}))}]);else{try{if(t=fs.openSync(dataFiles.cityNames,"r"),a=fs.fstatSync(t).size,0===a)throw{code:"EMPTY_FILE"};cache4.locationBuffer=Buffer.alloc(a),fs.readSync(t,cache4.locationBuffer,0,a,0),fs.closeSync(t),t=fs.openSync(dataFiles.city,"r"),a=fs.fstatSync(t).size}catch(e){if("ENOENT"!==e.code&&"EBADF"!==e.code&&"EMPTY_FILE"!==e.code)throw e;t=fs.openSync(dataFiles.country,"r"),a=fs.fstatSync(t).size,cache4.recordSize=10}cache4.mainBuffer=Buffer.alloc(a),fs.readSync(t,cache4.mainBuffer,0,a,0),fs.closeSync(t),cache4.lastLine=a/cache4.recordSize-1,cache4.lastIP=cache4.mainBuffer.readUInt32BE(cache4.lastLine*cache4.recordSize+4),cache4.firstIP=cache4.mainBuffer.readUInt32BE(0)}}function preload6(e){let t,a;const r=JSON.parse(JSON.stringify(conf6));if("function"==typeof arguments[0])async.series([e=>{async.series([e=>{fs.open(dataFiles.city6,"r",((a,r)=>{t=r,e(a)}))},e=>{fs.fstat(t,((t,r)=>{a=r.size,e(t)}))}],(c=>{if(c){if("ENOENT"!==c.code&&"EBADF"!==c.code)throw c;fs.open(dataFiles.country6,"r",((c,n)=>{c?e(c):(t=n,fs.fstat(t,((t,c)=>{a=c.size,r.recordSize=34,e()})))}))}else e()}))},()=>{r.mainBuffer=Buffer.alloc(a),async.series([e=>{fs.read(t,r.mainBuffer,0,a,0,e)},e=>{fs.close(t,e)}],(t=>{t||(r.lastLine=a/r.recordSize-1,cache6=r),e(t)}))}]);else{try{if(t=fs.openSync(dataFiles.city6,"r"),a=fs.fstatSync(t).size,0===a)throw{code:"EMPTY_FILE"}}catch(e){if("ENOENT"!==e.code&&"EBADF"!==e.code&&"EMPTY_FILE"!==e.code)throw e;t=fs.openSync(dataFiles.country6,"r"),a=fs.fstatSync(t).size,cache6.recordSize=34}cache6.mainBuffer=Buffer.alloc(a),fs.readSync(t,cache6.mainBuffer,0,a,0),fs.closeSync(t),cache6.lastLine=a/cache6.recordSize-1}}module.exports={cmp:utils.cmp,lookup:e=>{if(!e)return null;if("number"==typeof e)return lookup4(e);if(4===net.isIP(e))return lookup4(utils.aton4(e));if(6===net.isIP(e)){const t=get4mapped(e);return t?lookup4(utils.aton4(t)):lookup6(utils.aton6(e))}return null},pretty:e=>"string"==typeof e?e:"number"==typeof e?utils.ntoa4(e):Array.isArray(e)?utils.ntoa6(e):e,startWatchingDataUpdate:e=>{fsWatcher.makeFsWatchFilter(watcherName,geoDataDir,6e4,(()=>{async.series([e=>{preload(e)},e=>{preload6(e)}],e)}))},stopWatchingDataUpdate:()=>{fsWatcher.stopWatching(watcherName)},clear:()=>{cache4=JSON.parse(JSON.stringify(conf4)),cache6=JSON.parse(JSON.stringify(conf6))},reloadDataSync:()=>{preload(),preload6()},reloadData:e=>{async.series([e=>{preload(e)},e=>{preload6(e)}],e)},version:version},preload(),preload6();