'use strict';const{name:e,version:t}=require('../package.json');const n=`Mozilla/5.0 (compatible; ${e}/${t}; +https://sefinek.net)`;const o=require('node:fs');const s=require('node:http');const i=require('node:https');const r=require('node:path');const c=require('node:url');const l=require('node:zlib');o.existsSync=o.existsSync||r.existsSync;const a=require('async');const u=require('chalk');const d=require('iconv-lite');const p=require('lazy');const f=require('rimraf').sync;const g=require('adm-zip');const y=require('../lib/utils.js');const{Address6:h,Address4:m}=require('ip-address');const w=process.argv.slice(2);let S=w.find((function(e){return e.match(/^license_key=[a-zA-Z0-9]+/)!==null}));if(typeof S==='undefined'&&typeof process.env.LICENSE_KEY!=='undefined'){S='license_key='+process.env.LICENSE_KEY}let x=w.find((function(e){return e.match(/^geoDataDir=[\w./]+/)!==null}));if(typeof x==='undefined'&&typeof process.env.GEODATADIR!=='undefined'){x='geoDataDir='+process.env.GEODATADIR}let E=r.resolve(__dirname,'..','data');if(typeof x!=='undefined'){E=r.resolve(process.cwd(),x.split('=')[1]);if(!o.existsSync(E)){console.log(u.red('ERROR')+': Directory doesn\'t exist: '+E);process.exit(1)}}const k=r.resolve(__dirname,'..','tmp');const I={};const v={};const D=[{type:'country',url:'https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country-CSV&suffix=zip&'+S,checksum:'https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country-CSV&suffix=zip.sha256&'+S,fileName:'GeoLite2-Country-CSV.zip',src:['GeoLite2-Country-Locations-en.csv','GeoLite2-Country-Blocks-IPv4.csv','GeoLite2-Country-Blocks-IPv6.csv'],dest:['','geoip-country.dat','geoip-country6.dat']},{type:'city',url:'https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City-CSV&suffix=zip&'+S,checksum:'https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City-CSV&suffix=zip.sha256&'+S,fileName:'GeoLite2-City-CSV.zip',src:['GeoLite2-City-Locations-en.csv','GeoLite2-City-Blocks-IPv4.csv','GeoLite2-City-Blocks-IPv6.csv'],dest:['geoip-city-names.dat','geoip-city.dat','geoip-city6.dat']}];function C(e){const t=r.dirname(e);if(!o.existsSync(t))o.mkdirSync(t)}function R(e){let t=0;let n=-1;e=e.replace(/""/,'\\"').replace(/'/g,'\\\'');while(t<e.length&&n<e.length){t=n;n=e.indexOf(',',t+1);if(n<0)n=e.length;if(e.indexOf('\'',t||0)>-1&&e.indexOf('\'',t)<n&&e[t+1]!='"'&&e[n-1]!='"'){e=e.substr(0,t+1)+'"'+e.substr(t+1,n-t-1)+'"'+e.substr(n,e.length-n);n=e.indexOf(',',n+1);if(n<0)n=e.length}}return e}function B(e){const t=/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;const n=/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;if(!t.test(e)){e=R(e);if(!t.test(e)){return null}}const o=[];e.replace(n,(function(e,t,n,s){if(t!==undefined)o.push(t.replace(/\\'/g,'\''));else if(n!==undefined)o.push(n.replace(/\\"/g,'"').replace(/\\'/g,'\''));else if(s!==undefined)o.push(s);return''}));if(/,\s*$/.test(e))o.push('');return o}function _(e){const t=c.parse(e);t.headers={'User-Agent':n};if(process.env.http_proxy||process.env.https_proxy){try{const e=require('node:https-proxy-agent');t.agent=new e(process.env.http_proxy||process.env.https_proxy)}catch(e){console.error('Install https-proxy-agent to use an HTTP/HTTPS proxy');process.exit(-1)}}return t}function b(e,t){if(w.indexOf('force')!==-1){return t(null,e)}const n=e.checksum;if(typeof n==='undefined'){return t(null,e)}o.readFile(r.join(E,e.type+'.checksum'),{encoding:'utf8'},(function(o,r){if(!o&&r&&r.length)e.checkValue=r;console.log('Checking ',e.fileName);function c(n){const o=n.statusCode;if(o!==200){console.log(u.red('ERROR')+n.data);console.log(u.red('ERROR')+': HTTP Request Failed [%d %s]',o,s.STATUS_CODES[o]);l.abort();process.exit(1)}let i='';n.on('data',(function(e){i+=e}));n.on('end',(function(){if(i&&i.length){if(i==e.checkValue){console.log(u.green('Database "'+e.type+'" is up to date'));e.skip=true}else{console.log(u.green('Database '+e.type+' has new data'));e.checkValue=i}}else{console.log(u.red('ERROR')+': Could not retrieve checksum for',e.type,u.red('Aborting'));console.log('Run with "force" to update without checksum');l.abort();process.exit(1)}t(null,e)}))}var l=i.get(_(n),c)}))}function A(e,t){if(e.skip)return t(null,null,null,e);const n=e.url;let c=e.fileName;const a=r.extname(c)==='.gz';if(a)c=c.replace('.gz','');const d=r.join(k,c);if(o.existsSync(d))return t(null,d,c,e);console.log('Fetching ',c);function p(n){const i=n.statusCode;if(i!==200){console.error(u.red('ERROR')+': HTTP Request Failed [%d %s]',i,s.STATUS_CODES[i]);f.abort();process.exit(1)}let r;const p=o.createWriteStream(d);if(a){r=n.pipe(l.createGunzip()).pipe(p)}else{r=n.pipe(p)}r.on('close',(function(){console.log(u.green(' DONE'));t(null,d,c,e)}))}C(d);var f=i.get(_(n),p);process.stdout.write('Retrieving '+c+'...')}function O(e,t,n,s){if(n.skip){return s(null,n)}if(r.extname(t)!=='.zip'){s(null,n)}else{process.stdout.write('Extracting '+t+'...');const i=new g(e);const c=i.getEntries();c.forEach((e=>{if(e.isDirectory){return}const t=e.entryName.split('/');const n=t[t.length-1];const s=r.join(k,n);o.writeFileSync(s,e.getData())}));console.log(u.green(' DONE'));s(null,n)}}function q(e,t){function n(e){const t=B(e);if(!t||t.length<6){console.log('weird line: %s::',e);return}I[t[0]]=t[4]}const s=r.join(k,e);process.stdout.write('Processing Lookup Data (may take a moment)...');p(o.createReadStream(s)).lines.map((function(e){return d.decode(e,'latin1')})).skip(1).map(n).on('pipe',(function(){console.log(u.green(' DONE'));t()}))}function L(e,t,n){let s=0;function i(e){const t=B(e);if(!t||t.length<6){console.warn('weird line: %s::',e);return}s++;let n;let i;let r;const c=I[t[1]];let l;let u;let d;if(c){if(t[0].match(/:/)){u=34;r=new h(t[0]);n=y.aton6(r.startAddress().correctForm());i=y.aton6(r.endAddress().correctForm());l=Buffer.alloc(u);for(d=0;d<n.length;d++){l.writeUInt32BE(n[d],d*4)}for(d=0;d<i.length;d++){l.writeUInt32BE(i[d],16+d*4)}}else{u=10;r=new m(t[0]);n=parseInt(r.startAddress().bigInteger(),10);i=parseInt(r.endAddress().bigInteger(),10);l=Buffer.alloc(u);l.fill(0);l.writeUInt32BE(n,0);l.writeUInt32BE(i,4)}l.write(c,u-2);o.writeSync(g,l,0,u,null);if(Date.now()-a>5e3){a=Date.now();process.stdout.write('\nStill working ('+s+')...')}}}const c=r.join(E,t);const l=r.join(k,e);f(c);C(c);process.stdout.write('Processing data (may take a moment)...');var a=Date.now();var g=o.openSync(c,'w');p(o.createReadStream(l)).lines.map((function(e){return d.decode(e,'latin1')})).skip(1).map(i).on('pipe',(function(){console.log(u.green(' DONE'));n()}))}function F(e,t,n){let s=0;function i(e){if(e.match(/^Copyright/)||!e.match(/\d/)){return}const t=B(e);if(!t){console.warn('weird line: %s::',e);return}let n;let i;let r;let c;let l;let d;let p;let f;let g;let w;s++;if(t[0].match(/:/)){let e=0;d=48;r=new h(t[0]);n=y.aton6(r.startAddress().correctForm());i=y.aton6(r.endAddress().correctForm());c=parseInt(t[1],10);c=v[c];l=Buffer.alloc(d);l.fill(0);for(w=0;w<n.length;w++){l.writeUInt32BE(n[w],e);e+=4}for(w=0;w<i.length;w++){l.writeUInt32BE(i[w],e);e+=4}l.writeUInt32BE(c>>>0,32);p=Math.round(parseFloat(t[7])*1e4);f=Math.round(parseFloat(t[8])*1e4);g=parseInt(t[9],10);l.writeInt32BE(p,36);l.writeInt32BE(f,40);l.writeInt32BE(g,44)}else{d=24;r=new m(t[0]);n=parseInt(r.startAddress().bigInteger(),10);i=parseInt(r.endAddress().bigInteger(),10);c=parseInt(t[1],10);c=v[c];l=Buffer.alloc(d);l.fill(0);l.writeUInt32BE(n>>>0,0);l.writeUInt32BE(i>>>0,4);l.writeUInt32BE(c>>>0,8);p=Math.round(parseFloat(t[7])*1e4);f=Math.round(parseFloat(t[8])*1e4);g=parseInt(t[9],10);l.writeInt32BE(p,12);l.writeInt32BE(f,16);l.writeInt32BE(g,20)}o.writeSync(u,l,0,l.length,null);if(Date.now()-a>5e3){a=Date.now();process.stdout.write('\nStill working ('+s+')...')}}const c=r.join(E,t);const l=r.join(k,e);f(c);process.stdout.write('Processing Data (may take a moment) ...');var a=Date.now();var u=o.openSync(c,'w');p(o.createReadStream(l)).lines.map((function(e){return d.decode(e,'latin1')})).skip(1).map(i).on('pipe',n)}function U(e,t,n){let s=null;let i=0;function c(e){if(e.match(/^Copyright/)||!e.match(/\d/)){return}const t=Buffer.alloc(88);const n=B(e);if(!n){console.warn('weird line: %s::',e);return}s=parseInt(n[0]);v[s]=i;const r=n[4];const c=n[6];const l=n[10];const a=parseInt(n[11]);const d=n[12];const p=n[13];t.fill(0);t.write(r,0);t.write(c,2);if(a)t.writeInt32BE(a,5);t.write(p,9);t.write(d,10);t.write(l,42);o.writeSync(u,t,0,t.length,null);i++}const l=r.join(E,t);const a=r.join(k,e);f(l);var u=o.openSync(l,'w');p(o.createReadStream(a)).lines.map((function(e){return d.decode(e,'utf-8')})).skip(1).map(c).on('pipe',n)}function z(e,t){if(e.skip){return t(null,e)}const n=e.type;const o=e.src;const s=e.dest;if(n==='country'){if(Array.isArray(o)){q(o[0],(function(){L(o[1],s[1],(function(){L(o[2],s[2],(function(){t(null,e)}))}))}))}else{L(o,s,(function(){t(null,e)}))}}else if(n==='city'){U(o[0],s[0],(function(){F(o[1],s[1],(function(){console.log('city data processed');F(o[2],s[2],(function(){console.log(u.green(' DONE'));t(null,e)}))}))}))}}function G(e,t){if(e.skip||!e.checkValue){return t()}o.writeFile(r.join(E,e.type+'.checksum'),e.checkValue,'utf8',(function(n){if(n)console.log(u.red('Failed to Update checksums.'),'Database:',e.type);t()}))}if(!S){console.error(u.red('ERROR')+': Missing license_key');process.exit(1)}f(k);C(k);a.eachSeries(D,(function(e,t){a.seq(b,A,O,z,G)(e,t)}),(function(e){if(e){console.error(u.red('Failed to Update Databases from MaxMind.'),e);process.exit(1)}else{console.log(u.green('Successfully Updated Databases from MaxMind.'));if(w.indexOf('debug')!==-1){console.log(u.yellow.bold('Notice: temporary files are not deleted for debug purposes.'))}else{f(k)}process.exit(0)}}));