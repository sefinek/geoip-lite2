"use strict";const{name:name,version:version}=require("../package.json"),userAgent=`Mozilla/5.0 (compatible; ${name}/${version}; +https://sefinek.net)`,fs=require("node:fs"),http=require("node:http"),https=require("node:https"),path=require("node:path"),url=require("node:url"),zlib=require("node:zlib");fs.existsSync=fs.existsSync||path.existsSync;const async=require("async"),chalk=require("chalk"),iconv=require("iconv-lite"),lazy=require("lazy"),rimraf=require("rimraf").sync,AdmZip=require("adm-zip"),utils=require("../lib/utils.js"),{Address6:Address6,Address4:Address4}=require("ip-address"),args=process.argv.slice(2);let license_key=args.find((function(e){return null!==e.match(/^license_key=[a-zA-Z0-9]+/)}));void 0===license_key&&void 0!==process.env.LICENSE_KEY&&(license_key="license_key="+process.env.LICENSE_KEY);let geoDataDir=args.find((function(e){return null!==e.match(/^geoDataDir=[\w./]+/)}));void 0===geoDataDir&&void 0!==process.env.GEODATADIR&&(geoDataDir="geoDataDir="+process.env.GEODATADIR);let dataPath=path.resolve(__dirname,"..","data");void 0!==geoDataDir&&(dataPath=path.resolve(process.cwd(),geoDataDir.split("=")[1]),fs.existsSync(dataPath)||(console.log(chalk.red("ERROR")+": Directory doesn't exist: "+dataPath),process.exit(1)));const tmpPath=path.resolve(__dirname,"..","tmp"),countryLookup={},cityLookup={},databases=[{type:"country",url:"https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country-CSV&suffix=zip&"+license_key,checksum:"https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country-CSV&suffix=zip.sha256&"+license_key,fileName:"GeoLite2-Country-CSV.zip",src:["GeoLite2-Country-Locations-en.csv","GeoLite2-Country-Blocks-IPv4.csv","GeoLite2-Country-Blocks-IPv6.csv"],dest:["","geoip-country.dat","geoip-country6.dat"]},{type:"city",url:"https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City-CSV&suffix=zip&"+license_key,checksum:"https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City-CSV&suffix=zip.sha256&"+license_key,fileName:"GeoLite2-City-CSV.zip",src:["GeoLite2-City-Locations-en.csv","GeoLite2-City-Blocks-IPv4.csv","GeoLite2-City-Blocks-IPv6.csv"],dest:["geoip-city-names.dat","geoip-city.dat","geoip-city6.dat"]}];function mkdir(e){const t=path.dirname(e);fs.existsSync(t)||fs.mkdirSync(t)}function try_fixing_line(e){let t=0,n=-1;for(e=e.replace(/""/,'\\"').replace(/'/g,"\\'");t<e.length&&n<e.length;)t=n,n=e.indexOf(",",t+1),n<0&&(n=e.length),e.indexOf("'",t||0)>-1&&e.indexOf("'",t)<n&&'"'!=e[t+1]&&'"'!=e[n-1]&&(n=(e=e.substr(0,t+1)+'"'+e.substr(t+1,n-t-1)+'"'+e.substr(n,e.length-n)).indexOf(",",n+1),n<0&&(n=e.length));return e}function CSVtoArray(e){const t=/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;if(!t.test(e)&&(e=try_fixing_line(e),!t.test(e)))return null;const n=[];return e.replace(/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g,(function(e,t,o,s){return void 0!==t?n.push(t.replace(/\\'/g,"'")):void 0!==o?n.push(o.replace(/\\"/g,'"').replace(/\\'/g,"'")):void 0!==s&&n.push(s),""})),/,\s*$/.test(e)&&n.push(""),n}function getHTTPOptions(e){const t=url.parse(e);if(t.headers={"User-Agent":userAgent},process.env.http_proxy||process.env.https_proxy)try{const e=require("node:https-proxy-agent");t.agent=new e(process.env.http_proxy||process.env.https_proxy)}catch(e){console.error("Install https-proxy-agent to use an HTTP/HTTPS proxy"),process.exit(-1)}return t}function check(e,t){if(-1!==args.indexOf("force"))return t(null,e);const n=e.checksum;if(void 0===n)return t(null,e);fs.readFile(path.join(dataPath,e.type+".checksum"),{encoding:"utf8"},(function(o,s){!o&&s&&s.length&&(e.checkValue=s),console.log("Checking ",e.fileName);var r=https.get(getHTTPOptions(n),(function(n){const o=n.statusCode;200!==o&&(console.log(chalk.red("ERROR")+n.data),console.log(chalk.red("ERROR")+": HTTP Request Failed [%d %s]",o,http.STATUS_CODES[o]),r.abort(),process.exit(1));let s="";n.on("data",(function(e){s+=e})),n.on("end",(function(){s&&s.length?s==e.checkValue?(console.log(chalk.green('Database "'+e.type+'" is up to date')),e.skip=!0):(console.log(chalk.green("Database "+e.type+" has new data")),e.checkValue=s):(console.log(chalk.red("ERROR")+": Could not retrieve checksum for",e.type,chalk.red("Aborting")),console.log('Run with "force" to update without checksum'),r.abort(),process.exit(1)),t(null,e)}))}))}))}function fetch(e,t){if(e.skip)return t(null,null,null,e);const n=e.url;let o=e.fileName;const s=".gz"===path.extname(o);s&&(o=o.replace(".gz",""));const r=path.join(tmpPath,o);if(fs.existsSync(r))return t(null,r,o,e);console.log("Fetching ",o),mkdir(r);var i=https.get(getHTTPOptions(n),(function(n){const a=n.statusCode;let c;200!==a&&(console.error(chalk.red("ERROR")+": HTTP Request Failed [%d %s]",a,http.STATUS_CODES[a]),i.abort(),process.exit(1));const l=fs.createWriteStream(r);c=s?n.pipe(zlib.createGunzip()).pipe(l):n.pipe(l),c.on("close",(function(){console.log(chalk.green(" DONE")),t(null,r,o,e)}))}));process.stdout.write("Retrieving "+o+"...")}function extract(e,t,n,o){if(n.skip)return o(null,n);if(".zip"!==path.extname(t))o(null,n);else{process.stdout.write("Extracting "+t+"...");new AdmZip(e).getEntries().forEach((e=>{if(e.isDirectory)return;const t=e.entryName.split("/"),n=t[t.length-1],o=path.join(tmpPath,n);fs.writeFileSync(o,e.getData())})),console.log(chalk.green(" DONE")),o(null,n)}}function processLookupCountry(e,t){const n=path.join(tmpPath,e);process.stdout.write("Processing Lookup Data (may take a moment)..."),lazy(fs.createReadStream(n)).lines.map((function(e){return iconv.decode(e,"latin1")})).skip(1).map((function(e){const t=CSVtoArray(e);!t||t.length<6?console.log("weird line: %s::",e):countryLookup[t[0]]=t[4]})).on("pipe",(function(){console.log(chalk.green(" DONE")),t()}))}function processCountryData(e,t,n){let o=0;const s=path.join(dataPath,t),r=path.join(tmpPath,e);rimraf(s),mkdir(s),process.stdout.write("Processing data (may take a moment)...");var i=Date.now(),a=fs.openSync(s,"w");lazy(fs.createReadStream(r)).lines.map((function(e){return iconv.decode(e,"latin1")})).skip(1).map((function(e){const t=CSVtoArray(e);if(!t||t.length<6)return void console.warn("weird line: %s::",e);let n,s,r;o++;const c=countryLookup[t[1]];let l,p,u;if(c){if(t[0].match(/:/)){for(p=34,r=new Address6(t[0]),n=utils.aton6(r.startAddress().correctForm()),s=utils.aton6(r.endAddress().correctForm()),l=Buffer.alloc(p),u=0;u<n.length;u++)l.writeUInt32BE(n[u],4*u);for(u=0;u<s.length;u++)l.writeUInt32BE(s[u],16+4*u)}else p=10,r=new Address4(t[0]),n=parseInt(r.startAddress().bigInteger(),10),s=parseInt(r.endAddress().bigInteger(),10),l=Buffer.alloc(p),l.fill(0),l.writeUInt32BE(n,0),l.writeUInt32BE(s,4);l.write(c,p-2),fs.writeSync(a,l,0,p,null),Date.now()-i>5e3&&(i=Date.now(),process.stdout.write("\nStill working ("+o+")..."))}})).on("pipe",(function(){console.log(chalk.green(" DONE")),n()}))}function processCityData(e,t,n){let o=0;const s=path.join(dataPath,t),r=path.join(tmpPath,e);rimraf(s),process.stdout.write("Processing Data (may take a moment) ...");var i=Date.now(),a=fs.openSync(s,"w");lazy(fs.createReadStream(r)).lines.map((function(e){return iconv.decode(e,"latin1")})).skip(1).map((function(e){if(e.match(/^Copyright/)||!e.match(/\d/))return;const t=CSVtoArray(e);if(!t)return void console.warn("weird line: %s::",e);let n,s,r,c,l,p,u,d,f,h;if(o++,t[0].match(/:/)){let e=0;for(p=48,r=new Address6(t[0]),n=utils.aton6(r.startAddress().correctForm()),s=utils.aton6(r.endAddress().correctForm()),c=parseInt(t[1],10),c=cityLookup[c],l=Buffer.alloc(p),l.fill(0),h=0;h<n.length;h++)l.writeUInt32BE(n[h],e),e+=4;for(h=0;h<s.length;h++)l.writeUInt32BE(s[h],e),e+=4;l.writeUInt32BE(c>>>0,32),u=Math.round(1e4*parseFloat(t[7])),d=Math.round(1e4*parseFloat(t[8])),f=parseInt(t[9],10),l.writeInt32BE(u,36),l.writeInt32BE(d,40),l.writeInt32BE(f,44)}else p=24,r=new Address4(t[0]),n=parseInt(r.startAddress().bigInteger(),10),s=parseInt(r.endAddress().bigInteger(),10),c=parseInt(t[1],10),c=cityLookup[c],l=Buffer.alloc(p),l.fill(0),l.writeUInt32BE(n>>>0,0),l.writeUInt32BE(s>>>0,4),l.writeUInt32BE(c>>>0,8),u=Math.round(1e4*parseFloat(t[7])),d=Math.round(1e4*parseFloat(t[8])),f=parseInt(t[9],10),l.writeInt32BE(u,12),l.writeInt32BE(d,16),l.writeInt32BE(f,20);fs.writeSync(a,l,0,l.length,null),Date.now()-i>5e3&&(i=Date.now(),process.stdout.write("\nStill working ("+o+")..."))})).on("pipe",n)}function processCityDataNames(e,t,n){let o=null,s=0;const r=path.join(dataPath,t),i=path.join(tmpPath,e);rimraf(r);var a=fs.openSync(r,"w");lazy(fs.createReadStream(i)).lines.map((function(e){return iconv.decode(e,"utf-8")})).skip(1).map((function(e){if(e.match(/^Copyright/)||!e.match(/\d/))return;const t=Buffer.alloc(88),n=CSVtoArray(e);if(!n)return void console.warn("weird line: %s::",e);o=parseInt(n[0]),cityLookup[o]=s;const r=n[4],i=n[6],c=n[10],l=parseInt(n[11]),p=n[12],u=n[13];t.fill(0),t.write(r,0),t.write(i,2),l&&t.writeInt32BE(l,5),t.write(u,9),t.write(p,10),t.write(c,42),fs.writeSync(a,t,0,t.length,null),s++})).on("pipe",n)}function processData(e,t){if(e.skip)return t(null,e);const n=e.type,o=e.src,s=e.dest;"country"===n?Array.isArray(o)?processLookupCountry(o[0],(function(){processCountryData(o[1],s[1],(function(){processCountryData(o[2],s[2],(function(){t(null,e)}))}))})):processCountryData(o,s,(function(){t(null,e)})):"city"===n&&processCityDataNames(o[0],s[0],(function(){processCityData(o[1],s[1],(function(){console.log("city data processed"),processCityData(o[2],s[2],(function(){console.log(chalk.green(" DONE")),t(null,e)}))}))}))}function updateChecksum(e,t){if(e.skip||!e.checkValue)return t();fs.writeFile(path.join(dataPath,e.type+".checksum"),e.checkValue,"utf8",(function(n){n&&console.log(chalk.red("Failed to Update checksums."),"Database:",e.type),t()}))}license_key||(console.error(chalk.red("ERROR")+": Missing license_key"),process.exit(1)),rimraf(tmpPath),mkdir(tmpPath),async.eachSeries(databases,(function(e,t){async.seq(check,fetch,extract,processData,updateChecksum)(e,t)}),(function(e){e?(console.error(chalk.red("Failed to Update Databases from MaxMind."),e),process.exit(1)):(console.log(chalk.green("Successfully Updated Databases from MaxMind.")),-1!==args.indexOf("debug")?console.log(chalk.yellow.bold("Notice: temporary files are not deleted for debug purposes.")):rimraf(tmpPath),process.exit(0))}));